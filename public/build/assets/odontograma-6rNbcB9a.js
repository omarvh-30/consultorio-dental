document.addEventListener("DOMContentLoaded",function(){const r=document.getElementById("modalDiente");if(r){const t=new bootstrap.Modal(r),n=document.getElementById("dienteSeleccionado"),e=document.getElementById("inputDiente"),o=document.getElementById("estadoDiente"),s=document.getElementById("observacionesDiente"),a=document.getElementById("formDiente");[].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]')).map(function(i){return new bootstrap.Popover(i)});const f=document.querySelectorAll(".odontograma-svg .diente");f.length&&f.forEach(i=>{i.addEventListener("click",function(){const c=this.dataset.diente;n&&(n.textContent=c),e&&(e.value=c),o&&(o.value=this.classList.contains("sano")?"sano":this.classList.contains("caries")?"caries":this.classList.contains("obturado")?"obturado":this.classList.contains("endodoncia")?"endodoncia":this.classList.contains("extraido")?"extraido":"sano"),s&&(s.value=""),t.show()})}),a&&(a.onsubmit=async function(i){if(i.preventDefault(),a.dataset.enviando==="1")return;a.dataset.enviando="1";const c=new FormData(a);try{const y=await(await fetch(a.action,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"},body:c})).json();if(a.dataset.enviando="0",y.success){const p=e?e.value:null;if(p){const v=document.getElementById("diente-"+p);v&&o&&(v.className.baseVal="diente "+o.value)}t.hide(),a.reset(),location.reload()}else alert("Error al guardar: "+JSON.stringify(y.errors))}catch(m){a.dataset.enviando="0",console.error(m),alert("Error inesperado al guardar el diente.")}})}const l=document.getElementById("filtroDiente");l&&l.addEventListener("input",function(){const t=this.value.trim().toLowerCase(),n=document.querySelectorAll(".odontograma-svg .diente");n.length&&n.forEach(o=>{!t||o.dataset.diente.toLowerCase().includes(t)?(o.style.opacity=1,o.classList.add("resaltado")):(o.style.opacity=.2,o.classList.remove("resaltado"))});const e=document.querySelectorAll(".fila-historia");e.length&&e.forEach(o=>{const s=o.dataset.diente.toLowerCase();!t||s.includes(t)?o.style.display="":o.style.display="none"})});function g(){let t=0;const n=document.querySelectorAll(".precio");n.length&&n.forEach(o=>{let s=parseFloat(o.value)||0;t+=s});const e=document.getElementById("totalPlan");e&&(e.innerText="$"+t.toFixed(2))}const d=document.querySelectorAll(".precio");d.length&&d.forEach(t=>{t.addEventListener("input",g)});const u=document.getElementById("formPlan");u&&u.addEventListener("submit",function(t){let n=!0;document.querySelectorAll(".tratamiento").forEach(e=>{e.value==""&&(n=!1)}),document.querySelectorAll(".precio").forEach(e=>{e.value==""&&(n=!1)}),n||(t.preventDefault(),alert("Todos los dientes deben tener tratamiento y precio asignado"))}),l&&l.addEventListener("keyup",function(){let t=this.value.toLowerCase();const n=document.querySelectorAll(".fila-historia");n.length&&n.forEach(e=>{let o=e.dataset.diente.toLowerCase(),s=e.dataset.estado.toLowerCase(),a=(e.dataset.obs||"").toLowerCase();o.includes(t)||s.includes(t)||a.includes(t)?e.style.display="":e.style.display="none"})})});
